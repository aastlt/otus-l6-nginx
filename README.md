# Отказоустойчивый WordPress в Yandex Cloud (Terraform + Ansible)

Данный проект реализует автоматизированное развертывание отказоустойчивой инфраструктуры для веб-приложения WordPress в облаке Yandex Cloud.

## 1. Архитектура проекта
Стек технологий: **Terraform -> Ansible -> Nginx (LB) -> 2x Nginx + PHP-FPM 8.1 -> MariaDB**.

### Компоненты системы (IP адреса на момент создания кластера):
*   **Balancer (LB):** Nginx в роли балансировщика нагрузки (Внешний IP: `158.160.37.11`).
*   **App Nodes:** 2 сервера с Nginx и PHP-FPM, где размещен исходный код WordPress.
*   **DB Node:** Выделенный сервер базы данных MariaDB (Внутренний IP: `192.168.10.13`).
*   **Network:** VPC с NAT-шлюзом и Security Groups для фильтрации трафика (разрешены порты 80, 22 и внутренний обмен). Внешний IP только у балансировщика.

---

## 2. Развертывание инфраструктуры

### Этап 1: Инфраструктура как код (Terraform)
Создание виртуальных машин, сетей и правил доступа.
Секреты YC находятся в файле terraform.tfvars

    terraform apply -auto-approve

Актуальные адреса (Outputs):

    app_internal_ips = ["192.168.10.25", "192.168.10.15"]
    db_internal_ip = "192.168.10.13"
    lb_public_ip = "158.160.37.11"

### Этап 2: Конфигурация (Ansible)
Автоматическая установка ПО и связывание компонентов.

    ansible-playbook -i inventory.ini site.yml

Ключевые особенности конфигурации:

Динамический DB_HOST: IP-адрес базы данных автоматически извлекается из фактов хоста db и подставляется в wp-config.php.
Безопасность: Права на wp-config.php установлены в 0640 (владелец www-data).
Сетевая связность: Локальный файервол (UFW) отключен, управление трафиком перенесено на уровень облачных Security Groups.

### Этап 3: Настройка балансировки
Конфигурация Nginx на балансировщике поддерживает гибкое переключение методов распределения нагрузки.
Пример конфигурации Upstream (/etc/nginx/sites-enabled/balancer):

    upstream wordpress_backend {
        # ip_hash; # Раскомментировать - Привязка сессии по IP
        server 192.168.10.25:80;
        server 192.168.10.15:80;
    }


## 3. Тестирование

Тест 1: Метод Round-robin (Циклическая балансировка)
Запросы распределяются по очереди между серверами приложений.
Команда:

    for i in {1..4}; do curl -s 158.160.37.11/whoami.txt; done

Результат:

    RESPONDING FROM: APP-SERVER-2 (192.168.10.15)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-2 (192.168.10.15)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-2 (192.168.10.15)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)

Тест 2: Метод IP Hash (Привязка сессии)
Обеспечивает направление одного и того же клиента на один и тот же бэкенд.
Результат после включения ip_hash:

    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)
    RESPONDING FROM: APP-SERVER-1 (192.168.10.25)

Тест 3: Отказоустойчивость (Fault Tolerance)
Демонстрация работы сайта при выходе из строя одного бэкенда.

    Действие: Остановка Nginx на сервере wp-app-1.
    Проверка: curl -I -s 158.160.37.11 | grep HTTP.
    Результат: HTTP/1.1 200 OK.
    Балансировщик автоматически обнаружил сбой и перенаправил весь трафик на рабочий узел wp-app-2.

## 4. Итоги
В ходе выполнения проекта был реализован отказоустойчивый веб-стек. Система успешно проходит тесты на балансировку нагрузки и сохраняет работоспособность при потере одного из узлов приложения.

## Лицензия

MIT License

## Автор

aastlt
